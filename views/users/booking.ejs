<% layout('layouts/boilerplate') %>

<style>
  /* STRICT THEME SYNC */
  .font-manrope {
    font-family: "Manrope", sans-serif;
  }

  .material-symbols-outlined {
    font-variation-settings:
      "FILL" 1,
      "wght" 400,
      "GRAD" 0,
      "opsz" 24;
  }

  .brand-gradient {
    background: linear-gradient(135deg, #00b0ff 0%, #673ab6 100%) !important;
  }

  /* Precise Font Sizing from UI System */
  h1 {
    font-size: 1.25rem !important;
    font-weight: 900;
    letter-spacing: -0.025em;
  }
  h2 {
    font-size: 1rem !important;
    font-weight: 850;
    color: #0f172a;
  }
  h3 {
    font-size: 0.9rem !important;
    font-weight: 800;
    color: #0f172a;
  }

  .text-label {
    font-size: 0.7rem;
    font-weight: 700;
    color: #1e293b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .text-sub {
    font-size: 0.65rem;
    font-weight: 600;
    color: #64748b;
  }

  .glass-card {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .input-field {
    background: #f8fafc;
    border: 1px solid #f1f5f9;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .input-field:focus {
    background: #ffffff;
    border-color: #00b0ff;
    ring: 2px rgba(0, 176, 255, 0.1);
  }
</style>

<div
  class="bg-white font-manrope text-slate-900 antialiased min-h-screen pb-20"
>
  <main class="max-w-6xl mx-auto px-4 md:px-12 py-6">
    <nav
      class="flex items-center gap-1 mb-6 text-[9px] font-bold uppercase tracking-widest text-gray-400"
    >
      <a class="hover:text-indigo-600" href="/listings">Listings</a>
      <span class="material-symbols-outlined text-[10px]">chevron_right</span>
      <a class="hover:text-indigo-600" href="/listings/<%= listing._id %>"
        >Property Detail</a
      >
      <span class="material-symbols-outlined text-[10px]">chevron_right</span>
      <span class="text-slate-900">Confirm Booking</span>
    </nav>

    <h1 class="text-slate-900 mb-10">Confirm Your Stay</h1>

    <form action="/bookings/<%= listing._id %>" method="POST">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        <div class="lg:col-span-7 space-y-12">
          <section>
            <div class="flex items-center gap-2 mb-6">
              <span class="material-symbols-outlined text-indigo-500 text-lg"
                >calendar_today</span
              >
              <h2>Trip Dates</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-label ml-1">Check-in Date</label>
                <input
                  type="date"
                  name="checkIn"
                  id="checkIn"
                  required
                  class="input-field w-full rounded-xl py-3.5 px-4 outline-none"
                  min="<%= new Date().toISOString().split('T')[0] %>"
                />
              </div>

              <div class="space-y-2">
                <label class="text-label ml-1">Check-out Date</label>
                <input
                  type="date"
                  name="checkOut"
                  id="checkOut"
                  required
                  class="input-field w-full rounded-xl py-3.5 px-4 outline-none"
                  min="<%= new Date().toISOString().split('T')[0] %>"
                />
              </div>
            </div>
            <p
              class="mt-4 text-[10px] text-emerald-600 font-bold uppercase tracking-tight flex items-center gap-1"
            >
              <span class="material-symbols-outlined text-[14px]">bolt</span>
              Instant confirmation available
            </p>
          </section>

          <section>
            <div class="flex items-center gap-2 mb-6">
              <span class="material-symbols-outlined text-indigo-500 text-lg"
                >person</span
              >
              <h2>Traveler Details</h2>
            </div>
            <div
              class="bg-slate-50 border border-slate-100 p-6 rounded-2xl space-y-4"
            >
              <div class="flex justify-between items-center">
                <span class="text-sub">Booking Account</span>
                <span class="text-[11px] font-black uppercase text-slate-900"
                  ><%= currUser.username %></span
                >
              </div>
              <div class="space-y-2">
                <label class="text-label">Notes for the Host</label>
                <textarea
                  rows="3"
                  placeholder="Tell the host about your arrival time..."
                  class="input-field w-full rounded-xl py-3 px-4 outline-none resize-none"
                ></textarea>
              </div>
            </div>
          </section>
        </div>

        <div class="lg:col-span-5">
          <div
            class="glass-card rounded-3xl p-6 sticky top-24 border-slate-200/50 shadow-xl"
          >
            <div class="flex gap-4 mb-8">
              <div
                class="w-24 h-24 rounded-2xl overflow-hidden shrink-0 border border-slate-100"
              >
                <img
                  src="<%= listing.image.url %>"
                  class="w-full h-full object-cover"
                />
              </div>
              <div class="flex flex-col justify-center">
                <span
                  class="text-[8px] font-black text-indigo-500 uppercase tracking-widest mb-1"
                  >Luxury Stay</span
                >
                <h3 class="mb-1 leading-tight"><%= listing.title %></h3>
                <div
                  class="flex items-center gap-1 text-[10px] text-slate-400 font-bold"
                >
                  <span class="material-symbols-outlined text-xs"
                    >location_on</span
                  >
                  <%= listing.location %>
                </div>
              </div>
            </div>

            <div class="h-px bg-slate-100 mb-6"></div>

            <div class="space-y-4 mb-8">
              <div class="flex justify-between text-[11px] font-bold">
                <span class="text-slate-400 uppercase tracking-tighter"
                  >Nightly Rate</span
                >
                <span class="text-slate-900"
                  >₹<%= listing.price.toLocaleString("en-IN") %></span
                >
              </div>
              <div class="flex justify-between text-[11px] font-bold">
                <span class="text-slate-400 uppercase tracking-tighter"
                  >Service Fee</span
                >
                <span
                  class="text-emerald-600 uppercase tracking-tighter font-black"
                  >Waived</span
                >
              </div>
              <div class="flex justify-between text-[11px] font-bold">
                <span class="text-slate-400 uppercase tracking-tighter"
                  >Occupancy Taxes</span
                >
                <span class="text-slate-900">₹0</span>
              </div>
            </div>

            <div
              class="bg-indigo-50/30 border border-indigo-100 rounded-2xl p-6 mb-8"
            >
              <div class="flex justify-between items-end">
                <div>
                  <p
                    class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-1"
                  >
                    Total Amount
                  </p>
                  <p
                    class="text-3xl font-black bg-gradient-to-r from-[#00B0FF] to-[#673ab6] bg-clip-text text-transparent"
                    id="total-display"
                  >
                    ₹<%= listing.price.toLocaleString("en-IN") %>
                  </p>
                </div>
                <div class="text-right pb-1">
                  <span
                    class="text-[9px] font-black text-slate-400 uppercase tracking-tighter border border-slate-200 px-2 py-1 rounded-md"
                  >
                    Secure Link
                  </span>
                </div>
              </div>
            </div>

            <button
              type="submit"
              class="brand-gradient w-full text-white py-1.5 rounded-xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-indigo-200 active:scale-[0.98] transition-all flex items-center justify-center gap-2"
            >
              Proceed to Stripe
              <span class="material-symbols-outlined text-sm"
                >arrow_forward</span
              >
            </button>

            <div class="mt-6 flex items-center justify-center gap-2 opacity-30">
              <span class="material-symbols-outlined text-xs">lock</span>
              <span class="text-[8px] font-black uppercase tracking-widest"
                >SSL Encrypted Checkout</span
              >
            </div>
          </div>
        </div>
      </div>
    </form>
  </main>
</div>

<script>
  const checkInInput = document.getElementById('checkIn');
  const checkOutInput = document.getElementById('checkOut');
  const totalDisplay = document.getElementById('total-display');
  const basePrice = <%= listing.price %>;

  function calculateTotal() {
      if (checkInInput.value && checkOutInput.value) {
          const start = new Date(checkInInput.value);
          const end = new Date(checkOutInput.value);
          const diffTime = end - start;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          if (diffDays > 0) {
              const total = diffDays * basePrice;
              totalDisplay.innerText = `₹${total.toLocaleString("en-IN")}`;
          } else {
              totalDisplay.innerText = `₹${basePrice.toLocaleString("en-IN")}`;
          }
      }
  }

  checkInInput.addEventListener('change', calculateTotal);
  checkOutInput.addEventListener('change', calculateTotal);
</script>
