<!-- HEAD REQUIREMENTS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<body>
  <% if (success && success.length > 0) { %>
  <div class="alert alert-success"><%= success %></div>
  <% } %>

  <% if (error && error.length > 0) { %>
  <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <aside class="sidebar">
    <div class="logo"><i class="fas fa-rocket"></i> Wanderlust Admin</div>
    <ul class="menu" id="menu-list">
      <li data-section="dashboard" class="active"><a href="#"><i class="fas fa-chart-line"></i> Dashboard</a></li>
      <li data-section="users"><a href="#"><i class="fas fa-users"></i> Users</a></li>
      <li data-section="listings"><a href="#"><i class="fas fa-house-chimney"></i> Listings</a></li>
      <li data-section="reviews"><a href="#"><i class="fas fa-star"></i> Reviews</a></li>
      <li data-section="bookings"><a href="#"><i class="fas fa-calendar-check"></i> Bookings</a></li>
    </ul>

    <div class="sidebar-footer">
      <a href="/admin/edit" class="action-link"><i class="fas fa-user-gear"></i> Edit Profile</a>
      <a href="/listings" class="action-link"><i class="fas fa-arrow-left"></i> Back to Listings</a>
    </div>
  </aside>

  <div class="main-container">
    <header class="dashboard-header">
      <div class="header-status">
        Welcome, <%= admin?.username || "Admin User" %>
      </div>

      <div class="user-menu-wrapper">
        <div class="user-info">
          <div class="user-text">
            <span class="role"><%= admin?.role || "System Administrator" %></span>
          </div>
          <img src="<%= currUser.profileImage ? currUser.profileImage : '/images/default.jpg' %>" class="nav-profile-img" />
          <i class="fas fa-angle-down dropdown-arrow"></i>
        </div>

        <div class="dropdown-menu">
          <a href="/admin/edit" class="dropdown-item"><i class="fas fa-user-gear"></i> Edit Profile</a>
          <a href="/listings" class="dropdown-item"><i class="fas fa-arrow-left"></i> Back to Listings</a>
          <div class="dropdown-divider"></div>
          <a href="/logout" class="dropdown-item logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </header>

    <main class="main-content">

      <!-- DASHBOARD -->
      <section class="section" id="dashboard">
        <h2 class="section-title">Overview Metrics</h2>

        <div class="metrics-grid">
          <div class="metric-card"><i class="fas fa-users card-icon"></i><span class="metric-value"><%= totalUsers %></span><span class="metric-label">Total Users</span></div>
          <div class="metric-card"><i class="fas fa-house-chimney card-icon"></i><span class="metric-value"><%= totalListings %></span><span class="metric-label">Total Listings</span></div>
          <div class="metric-card"><i class="fas fa-star card-icon"></i><span class="metric-value"><%= totalReviews %></span><span class="metric-label">Reviews Count</span></div>
          <div class="metric-card"><i class="fas fa-dollar-sign card-icon"></i><span class="metric-value">$<%= monthlyRevenue %></span><span class="metric-label">Monthly Revenue</span></div>
        </div>

        <h2 class="section-title">Monthly Revenue Trend</h2>
        <div class="card-list-item chart-container">
          <canvas id="revenueChart"></canvas>
        </div>
      </section>

      <!-- USERS -->
      <section class="section" id="users">
        <h2 class="section-title">User Management</h2>
        <% if(users.length === 0){ %>
        <div class="empty-msg">No users & host yet üö´</div>
        <% } else { users.forEach(user => { %>
        <div class="card-list-item">
          <span>    <%= user.name %> (<%= user.email %>) - <%= user.role %></span>

          <div class="actions">
            <a href="/admin/users/<%= user._id %>" class="view-btn rounded-pill">View</a>

            <form action="/admin/users/<%= user._id %>/delete" method="POST" style="display:inline;">
              <button class="delete-btn rounded-pill">Delete</button>
            </form>
          </div>

        </div>
        <% }) } %>
      </section>

      <!-- LISTINGS -->
      <section class="section" id="listings">
        <h2 class="section-title">Active Listings</h2>
        <% if(listings.length === 0){ %>
        <div class="empty-msg">No listings yet üö´</div>
        <% } else { listings.forEach(item => { %>
        <div class="card-list-item">
          <span><%= item.title %></span>

          <div class="actions">
            <a href="/listings/<%= item._id %>" class="view-btn rounded-pill">View</a>

            <form action="/listings/<%= item._id %>?_method=DELETE" method="POST" style="display:inline;">
              <button class="delete-btn rounded-pill">Delete</button>
            </form>
          </div>

        </div>
        <% }) } %>
      </section>

      <!-- REVIEWS -->
      <section class="section" id="reviews">
        <h2 class="section-title">Recent Reviews</h2>
        <% if(reviews.length === 0){ %>
        <div class="empty-msg">No reviews yet üö´</div>
        <% } else { reviews.forEach(r => { %>
        <div class="card-list-item">
          <span><strong><%= r.listing?.title || "Listing removed" %></strong> ‚≠ê <%= r.rating %></span>

          <div class="actions">
            <a class="view-btn rounded-pill" href="/listings/<%= r.listing._id %>">View</a>
            <% if (r.listing) { %>
            <form action="/listings/<%= r.listing._id %>/reviews/<%= r._id %>?_method=DELETE" method="POST" style="display:inline;">
              <button class="delete-btn rounded-pill">Delete</button>
            </form>
            <% } %>

          </div>

        </div>
        <% }) } %>
      </section>

      <!-- BOOKINGS -->
      <section class="section" id="bookings">
        <h2 class="section-title">Latest Bookings</h2>
        <% if(bookings.length === 0){ %>
        <div class="empty-msg">No bookings yet üö´</div>
        <% } else { bookings.forEach(b => { %>
        <div class="card-list-item">
          <span>Booking for: <%= b.listing?.title || "Listing removed" %></span>

          <div class="actions">
            <a href="/admin/bookings/<%= b._id %>" class="view-btn rounded-pill">View</a>

            <form action="/admin/bookings/<%= b._id %>/delete" method="POST" style="display:inline;">
              <button class="delete-btn rounded-pill">Delete</button>
            </form>
          </div>

        </div>
        <% }) } %>
      </section>

    </main>
  </div>

  <script>
    // CONTENT_LOAD:
    window.addEventListener("load", () => {
      document.body.classList.add("loaded");
    });



    // <!-- ===== SHORT SCRIPT FOR EDIT/DELETE BUTTONS ONLY ===== -->


    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("edit-btn")) {
        const id = e.target.dataset.id;
        const type = e.target.dataset.type;
        window.location.href = `/admin/${type}/edit/${id}`;
      }

      if (e.target.classList.contains("delete-btn")) {
        const id = e.target.dataset.id;
        const type = e.target.dataset.type;

        if (confirm(`Delete this ${type}?`)) {
          window.location.href = `/admin/${type}/delete/${id}`;
        }
      }
    });




    // ======= USER DROPDOWN =======
    const userMenu = document.querySelector(".user-menu-wrapper");
    userMenu.addEventListener("click", () => userMenu.classList.toggle("open"));
    document.addEventListener("click", (e) => {
      if (!userMenu.contains(e.target)) userMenu.classList.remove("open");
    });

    // ======= SIDEBAR SECTION SWITCHING =======
    const menuItems = document.querySelectorAll(".menu li");
    const sections = document.querySelectorAll(".section");

    const showSection = (id) => {
      sections.forEach((s) => (s.style.display = "none"));
      const el = document.getElementById(id);
      if (el) el.style.display = "block";
    };

    // Default section
    showSection("dashboard");

    menuItems.forEach((item) => {
      item.addEventListener("click", (e) => {
        e.preventDefault();

        menuItems.forEach((i) => i.classList.remove("active"));
        item.classList.add("active");

        showSection(item.dataset.section);
      });
    });

    // ======= REVENUE CHART =======
    const ctx = document.getElementById("revenueChart");
    if (ctx) {
      new Chart(ctx, {
        type: "line",
        data: {
          labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"],
          datasets: [{
            label: "Monthly Revenue ($)",
            data: [5000, 7500, 6000, 9000, 10500, 12450, 11000],
            borderColor: "#ff385c",
            backgroundColor: "rgba(255,56,92,0.1)",
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointBackgroundColor: "#ff385c",
          }, ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              title: {
                display: true,
                text: "Revenue (USD)"
              },
              grid: {
                color: "#e9ecef"
              },
            },
            x: {
              grid: {
                display: false
              }
            },
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (ctx) =>
                  `${ctx.dataset.label}: ${new Intl.NumberFormat("en-US", {
                    style: "currency",
                    currency: "USD",
                  }).format(ctx.parsed.y)}`,
              },
            },
          },
        },
      });
    }
  </script>
</body>

<style>
  /* --- FULL WANDERLUST VERDANT LIGHT MODE CSS (Fresh & Professional) --- */

  /* Base Variables for Light Theme */
  :root {
    --sidebar-width: 240px;
    --main-bg: #f5f6f8;
    /* Very subtle off-white background */
    --card-bg: #ffffff;
    /* Pure white for cards/surfaces */
    --accent-start: #16a085;
    /* Deep Teal/Green */
    --accent-end: #2ecc71;
    /* Emerald Green */
    --primary-gradient: linear-gradient(90deg,
        var(--accent-start),
        var(--accent-end));
    --text-dark: #2c3e50;
    /* Dark navy for main text */
    --text-muted: #7f8c8d;
    /* Muted gray for secondary info */
    --border-color: #ecf0f1;
    /* Very light gray border */
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.05);
    /* Very light shadow */
  }

  /* RESET */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Poppins", sans-serif;
  }

  body {
    display: flex;
    /* Keep flex for fixed sidebar layout */
    background: var(--main-bg);
    color: var(--text-dark);
    min-height: 100vh;
  }


  .menu {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
    margin-left: -2rem;
  }

  /* --- 1. SIDEBAR (Fixed and Accent Colored) --- */
  .sidebar {
    width: var(--sidebar-width);
    height: 100vh;
    background: var(--primary-gradient);
    /* Use the new Teal/Green gradient */
    color: #fff;
    padding: 25px 20px;
    position: fixed;
    top: 0;
    left: 0;
    display: flex;
    flex-direction: column;
    transition: all 0.3s;
    /* Use a lighter, cleaner shadow for the fixed element */
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
    z-index: 200;
  }

  .sidebar .logo {
    font-size: 26px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 50px;
    color: #fff;
    letter-spacing: 1px;
  }

  .sidebar ul {
    list-style: none;
  }

  .sidebar ul li {
    margin-bottom: 8px;
    /* Tighter spacing for professional look */
  }

  .sidebar ul li a {
    color: rgba(255, 255, 255, 0.85);
    text-decoration: none;
    padding: 10px 15px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
    transition: all 0.3s;
    position: relative;
  }

  .sidebar ul li.active a {
    /* Use a very subtle white background for active state */
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    font-weight: 600;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .sidebar ul li a:hover:not(.active) {
    background: rgba(0, 0, 0, 0.1);
    color: #fff;
  }

  .sidebar-footer {
    padding-top: 20px;
    margin-left: 1rem;
    margin-top: auto;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .sidebar-footer .action-link {
    color: rgba(255, 255, 255, 0.85);
    font-size: 14px;
    text-decoration: none;
    padding: 5px 0;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .sidebar-footer .action-link:hover {
    color: #fff;
    text-decoration: underline;
  }

  /* --- 2. MAIN LAYOUT (Fixed Sidebar Offset) --- */

  .main-container {
    /* Offset for fixed sidebar */
    margin-left: var(--sidebar-width);
    width: calc(100% - var(--sidebar-width));
    min-height: 100vh;
  }

  /* HEADER (Sticky - Light Background) */
  .dashboard-header {
    position: sticky;
    top: 0;
    height: 65px;
    /* Slightly shorter header */
    background: var(--card-bg);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0 30px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    /* Very subtle shadow */
    z-index: 100;
    border-bottom: 1px solid var(--border-color);
  }

  /* --- User Info & Dropdown --- */
  .user-menu-wrapper {
    position: relative;
    cursor: pointer;
    user-select: none;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px;
    border-radius: 8px;
    transition: background 0.2s;
  }

  .user-menu-wrapper.open .user-info,
  .user-info:hover {
    background: var(--border-color);
  }

  .user-info .avatar {
    border: 2px solid var(--accent-start);
    /* Use new accent color */
    width: 35px;
    /* Slightly smaller avatar */
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
  }

  .user-info .username {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-dark);
  }

  .user-info .role {
    color: var(--text-muted);
    font-size: 11px;
  }

  .dropdown-arrow {
    color: var(--text-muted);
  }

  .dropdown-menu {
    width: 200px;
    background: var(--card-bg);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  .dropdown-item {
    color: var(--text-dark);
    font-size: 13px;
  }

  .dropdown-item i {
    color: var(--text-muted);
  }

  .dropdown-item:hover {
    background: var(--main-bg);
    color: var(--accent-start);
  }

  .dropdown-item:hover i {
    color: var(--accent-start);
  }

  .dropdown-divider {
    background: var(--border-color);
  }

  .logout-btn {
    color: #e74c3c;
    /* Use standard red for logout */
  }

  .logout-btn:hover {
    background: rgba(231, 76, 60, 0.1);
  }

  /* MAIN CONTENT */
  .main-content {
    padding: 30px;
    /* Space for the sticky header (65px header + 30px margin) */
    padding-top: 95px;
  }

  .section-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 20px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--border-color);
  }

  /* --- 3. METRIC CARDS & LISTS --- */

  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 35px;
  }

  .metric-card {
    background: var(--card-bg);
    padding: 20px;
    /* Slightly less padding */
    border-radius: 10px;
    box-shadow: var(--shadow-light);
    /* Accent Border */
    border-left: 4px solid var(--accent-end);
    /* Slightly thinner border */
    gap: 6px;
  }

  .metric-card:hover {
    transform: translateY(-2px);
    /* Less aggressive lift on hover */
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    border-left-color: var(--accent-start);
  }

  /* FIX: Ensures icons are visible and styled correctly */
  .card-icon,
  .metric-card i {
    font-size: 22px;
    color: var(--accent-start);
    background: rgba(22, 160, 133, 0.1);
    /* Light bubble background */
    padding: 8px;
    border-radius: 6px;
  }

  .metric-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-dark);
  }

  .metric-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  /* --- CHART CONTAINER STYLE --- */
  .chart-container {
    height: 400px;
    padding: 25px;
    margin-top: 20px;
    background: var(--card-bg);
    border-radius: 10px;
    box-shadow: var(--shadow-light);
  }

  .card-list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--card-bg);
    margin-bottom: 10px;
    padding: 12px 18px;
    border-radius: 6px;
    box-shadow: none;
    /* Removed individual item shadows */
    border: 1px solid var(--border-color);
  }

  .card-list-item:hover {
    border-color: var(--accent-end);
    box-shadow: 0 2px 8px rgba(22, 160, 133, 0.1);
  }

  .rating-pill {
    background: #3498db;
    /* Blue for a fresh rating look */
    color: #fff;
    font-size: 11px;
    padding: 2px 7px;
    border-radius: 3px;
  }

  /* Action Buttons (More Professional Look) */
  .view-btn {
    text-decoration: none;
    background: linear-gradient(135deg, #3498db, #2980b9);
    /* Blue gradient for view */
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    box-shadow: 0 3px 8px rgba(52, 152, 219, 0.2);
  }

  .edit-btn {
    background: var(--card-bg);
    color: var(--accent-start);
    padding: 6px 12px;
    border: 1px solid var(--accent-start);
    border-radius: 6px;
    font-size: 13px;
    box-shadow: none;
  }

  .edit-btn:hover {
    background: rgba(22, 160, 133, 0.1);
    opacity: 1;
  }


  .delete-btn {
    background: #e74c3c;
    color: #fff;
    padding: 5px 10px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    box-shadow: 0 3px 8px rgba(231, 76, 60, 0.2);
  }

  .empty-msg {
    background: var(--card-bg);
    border: 1px dashed var(--border-color);
    color: var(--text-muted);
  }



  .nav-profile-img {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    border: 1px solid #16a085;
    object-fit: cover;
    object-position: center;
    transition: transform 0.2s ease;
  }

  .nav-profile-img:hover {
    transform: scale(1.1);
  }

  /* üõ†Ô∏è 4. RESPONSIVE FIXES (Re-using the previous structure but applied to light mode) üõ†Ô∏è */
  @media (max-width: 992px) {

    /* 1. Reset body stacking to column flow */
    body {
      flex-direction: column;
    }

    /* 2. Turn fixed sidebar into a regular flow element */
    .sidebar {
      width: 100%;
      height: auto;
      position: relative;
      box-shadow: none;
      flex-direction: row;
      flex-wrap: wrap;
      align-items: center;
      padding-top: 15px;
      padding-bottom: 15px;
    }

    /* 3. Re-organize sidebar children for horizontal layout */
    .sidebar .logo {
      margin-bottom: 15px;
      margin-right: 20px;
      text-align: left;
      width: 100%;
    }

    .sidebar ul {
      flex-direction: row;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
      border-right: none;
      display: flex;
      width: 100%;
    }

    .sidebar ul li {
      margin-bottom: 0;
    }

    .sidebar ul li a {
      padding: 8px 12px;
    }

    .sidebar-footer {
      margin-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: row;
      gap: 15px;
      padding-top: 15px;
      width: 100%;
    }

    /* 4. Reset main-container positioning and size */
    .main-container {
      margin-left: 0;
      width: 100%;
    }

    /* 5. Fix header position and stacking */
    .dashboard-header {
      position: sticky;
      top: 0;
      left: 0;
      justify-content: flex-end;
      /* Keep user menu to the right */
      width: 100%;
    }

    /* 6. Fix main-content padding - remove excessive top padding */
    .main-content {
      padding-top: 30px;
    }
  }




  /* drop down */

  /* CSS Snippet from your code */
  .dropdown-menu {
    /* ... styles ... */
    display: none;
    /* Initially hidden */
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.2s, transform 0.2s;
    width: 5rem;
  }

  .user-menu-wrapper.open .dropdown-menu {
    display: block;
    /* Becomes visible */
    opacity: 1;
    transform: translateY(0);
  }

  .user-menu-wrapper.open .dropdown-arrow {
    transform: rotate(180deg);
    /* Arrow rotation */
  }


  /* Prevent horizontal scrolling when the dropdown is open */
  .dropdown-open-active {
    overflow-x: hidden;
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    width: 200px;
    /* ... other styles ... */

    /* ADD THIS LINE to compensate for potential overflow */
    margin-right: -1px;
  }

  /* Further refinements for small phones */
  @media (max-width: 576px) {
    .sidebar .logo {
      font-size: 22px;
    }

    .sidebar ul {
      flex-direction: column;
      width: 100%;
    }

    .sidebar ul li a {
      width: 100%;
    }

    .sidebar-footer {
      flex-direction: column;
      gap: 5px;
    }

    .metrics-grid {
      grid-template-columns: 1fr;
    }
  }