<% layout('/layouts/boilerplate') %>



<style>
  .material-symbols-outlined { 
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    vertical-align: middle;
    line-height: 1;
  }
  body { font-family: 'Manrope', sans-serif; }
  .tab-section { display: none; }
  .tab-section.active { display: block; }
  
  /* Hide scrollbar for tab navigation on mobile */
  .hide-scrollbar::-webkit-scrollbar { display: none; }
  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<main class="max-w-[1200px] mx-auto px-4 md:px-6 py-6 md:py-10">
  
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8 md:mb-12">
    <div class="flex flex-col sm:flex-row items-center sm:items-start gap-4 md:gap-8">
      <div class="h-20 w-20 md:h-28 md:w-28 rounded-2xl bg-cover bg-center shadow-lg ring-4 ring-white shrink-0" 
           style="background-image: url('<%= currUser.profileImage ? currUser.profileImage : '/images/default.jpg' %>')">
      </div>

      <div class="flex flex-col items-center sm:items-start text-center sm:text-left">
        <div class="flex flex-col sm:flex-row items-center gap-2 md:gap-4">
          <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight text-slate-900">Hello, <%= user?.username || "User" %></h1>
          <span class="flex items-center gap-1 bg-accent-emerald/10 text-accent-emerald px-3 py-1 rounded-full text-[10px] md:text-xs font-bold uppercase tracking-wider border border-accent-emerald/20">
            <span class="material-symbols-outlined !text-sm">verified</span> Verified
          </span>
        </div>
        
        <p class="text-[#4e7397] mt-2 text-base md:text-xl font-medium max-w-lg leading-relaxed">
          Manage your listings, bookings & earnings effortlessly.
        </p>
        
        <a href="/edit" class="text-primary text-sm font-bold hover:text-primary/80 transition-colors mt-3 inline-flex items-center gap-1">
          <span class="material-symbols-outlined !text-base">edit_square</span>
          Edit Profile
        </a>
      </div>
    </div>
    
    <div class="shrink-0">
      <a href="/listings/new" class="w-full md:w-auto justify-center bg-primary text-white text-sm md:text-base font-bold px-8 py-4 rounded-xl hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 flex items-center gap-2">
        <span class="material-symbols-outlined !text-xl">add_circle</span>
        Add New Listing
      </a>
    </div>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mb-8 md:mb-10">
    <div class="bg-white p-5 md:p-6 rounded-xl border border-[#e7edf3] shadow-sm hover:shadow-md transition-shadow">
      <div class="flex justify-between items-center mb-2 md:mb-4">
        <div class="p-2.5 bg-accent-purple/10 rounded-xl text-accent-purple">
          <span class="material-symbols-outlined !text-2xl md:!text-3xl">home_work</span>
        </div>
        <p class="text-[#4e7397] font-semibold text-sm">Total Listings</p>
      </div>
      <p class="text-3xl md:text-4xl font-black mt-1"><%= totalListings %></p>
    </div>

    <div class="bg-white p-5 md:p-6 rounded-xl border border-[#e7edf3] shadow-sm hover:shadow-md transition-shadow">
      <div class="flex justify-between items-center mb-2 md:mb-4">
        <div class="p-2.5 bg-primary/10 rounded-xl text-primary">
          <span class="material-symbols-outlined !text-2xl md:!text-3xl">calendar_month</span>
        </div>
        <p class="text-[#4e7397] font-semibold text-sm">Total Bookings</p>
      </div>
      <p class="text-3xl md:text-4xl font-black mt-1"><%= totalBookings %></p>
    </div>

    <div class="bg-white p-5 md:p-6 rounded-xl border border-[#e7edf3] shadow-sm hover:shadow-md transition-shadow sm:col-span-2 md:col-span-1">
      <div class="flex justify-between items-center mb-2 md:mb-4">
        <div class="p-2.5 bg-accent-emerald/10 rounded-xl text-accent-emerald">
          <span class="material-symbols-outlined !text-2xl md:!text-3xl">star</span>
        </div>
        <p class="text-[#4e7397] font-semibold text-sm">Guest Reviews</p>
      </div>
      <p class="text-3xl md:text-4xl font-black mt-1"><%= totalReviews %></p>
    </div>
  </div>

  <div class="border-b border-[#d0dbe7] mb-8 overflow-x-auto hide-scrollbar">
    <div class="flex gap-6 md:gap-10 min-w-max">
      <button class="tab-btn-v2 pb-4 border-b-2 border-primary text-primary font-bold text-sm flex items-center gap-2 transition-all active-tab" data-tab="listings">
        <span class="material-symbols-outlined !text-lg">list_alt</span> My Listings
      </button>
      <button class="tab-btn-v2 pb-4 border-b-2 border-transparent text-[#4e7397] font-bold text-sm flex items-center gap-2 hover:text-primary transition-all" data-tab="bookings">
        <span class="material-symbols-outlined !text-lg">confirmation_number</span> Bookings
      </button>
      <button class="tab-btn-v2 pb-4 border-b-2 border-transparent text-[#4e7397] font-bold text-sm flex items-center gap-2 hover:text-primary transition-all" data-tab="reviews">
        <span class="material-symbols-outlined !text-lg">rate_review</span> Reviews
      </button>
    </div>
  </div>

  <div class="host-content-v2">
    
    <section class="tab-section active" id="listings">
      <div class="grid grid-cols-1 gap-4 md:gap-6">
        <% if(listings.length === 0) { %>
          <div class="text-center py-12 bg-white rounded-xl border border-dashed border-[#d0dbe7]">
            <p class="text-[#4e7397]">No listings added yet. Let's get started!</p>
          </div>
        <% } else { %>
          <% listings.forEach(listing => { %>
            <div class="bg-white p-3 md:p-4 rounded-xl border border-[#e7edf3] flex flex-col md:flex-row gap-4 md:gap-6 shadow-sm hover:shadow-md transition-shadow">
              <div class="w-full md:w-64 h-48 md:h-44 rounded-lg bg-cover bg-center shrink-0" 
                   style="background-image: url('<%= listing.image?.url || '/images/default.jpg' %>')"></div>
              <div class="flex flex-col justify-between flex-grow py-1">
                <div>
                  <div class="flex items-start justify-between gap-2">
                    <h3 class="text-lg md:text-xl font-bold leading-tight"><%= listing.title %></h3>
                    <span class="text-accent-emerald bg-accent-emerald/10 text-[10px] font-bold px-2 py-0.5 rounded uppercase shrink-0 mt-1">Active</span>
                  </div>
                  <div class="flex items-center gap-2 mt-1 text-[#4e7397]">
                    <span class="material-symbols-outlined !text-base">location_on</span>
                    <span class="text-xs md:text-sm"><%= listing.location %></span>
                  </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center justify-between mt-4 gap-4">
                   <div class="flex items-baseline gap-1">
                     <span class="text-xl font-bold">â‚¹<%= listing.price.toLocaleString("en-IN") %></span>
                     <span class="text-xs font-normal text-[#4e7397]">/night</span>
                   </div>
                   <div class="grid grid-cols-3 sm:flex items-stretch rounded-lg border border-[#d0dbe7] overflow-hidden">
                      <a href="/listings/<%= listing._id %>" class="px-3 py-2 text-xs md:text-sm font-bold text-primary bg-white hover:bg-primary/5 transition-colors border-r border-[#d0dbe7] text-center">View</a>
                      <a href="/listings/<%= listing._id %>/edit" class="px-3 py-2 text-xs md:text-sm font-bold text-[#4e7397] bg-white hover:bg-slate-50 transition-colors border-r border-[#d0dbe7] text-center">Edit</a>
                      <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Delete this listing?')" class="h-full">
                        <button class="w-full h-full px-3 py-2 text-xs md:text-sm font-bold text-red-500 bg-white hover:bg-red-50 transition-colors text-center">Delete</button>
                      </form>
                   </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </section>

    <section class="tab-section" id="bookings">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <% if (bookings.length > 0) { %>
          <% bookings.forEach(booking => { %>
            <div class="bg-white p-5 md:p-6 rounded-xl border border-[#e7edf3] shadow-sm">
              <div class="flex items-center gap-4 mb-4">
                <div class="size-10 md:size-12 rounded-lg bg-primary/10 text-primary flex items-center justify-center shrink-0">
                  <span class="material-symbols-outlined !text-xl md:!text-2xl">event_available</span>
                </div>
                <div>
                  <h4 class="font-bold text-base md:text-lg leading-tight"><%= booking.listing ? booking.listing.title : "Property N/A" %></h4>
                  <p class="text-xs md:text-sm text-[#4e7397]">Guest: <%= booking.user?.username || "Guest" %></p>
                </div>
              </div>
              <div class="flex justify-between border-t pt-4 gap-2">
                <div>
                  <p class="text-[#4e7397] text-[10px] uppercase font-bold">Check-In</p>
                  <p class="text-sm font-semibold"><%= booking.checkIn.toDateString() %></p>
                </div>
                <div class="text-right">
                  <p class="text-[#4e7397] text-[10px] uppercase font-bold">Check-Out</p>
                  <p class="text-sm font-semibold"><%= booking.checkOut.toDateString() %></p>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="text-center py-12 bg-white rounded-xl border border-[#e7edf3]">
            <p class="text-[#4e7397]">No bookings yet.</p>
          </div>
        <% } %>
      </div>
    </section>

    <section class="tab-section" id="reviews">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
        <% if (reviews.length === 0) { %>
          <div class="sm:col-span-2 lg:col-span-3 text-center py-12 bg-white rounded-xl border border-[#e7edf3]">
            <p class="text-[#4e7397]">No guest reviews yet ðŸš«</p>
          </div>
        <% } else { %>
          <% reviews.forEach(r => { %>
            <div class="bg-white p-5 md:p-6 rounded-xl border border-[#e7edf3] shadow-sm flex flex-col justify-between">
              <div>
                <div class="flex items-center gap-3 mb-4">
                  <img src="<%= r.author?.profileImage || '/images/default.jpg' %>" class="size-9 rounded-full object-cover shadow-sm border border-slate-100" />
                  <span class="font-bold text-sm"><%= r.author?.username || "User" %></span>
                </div>
                <div class="flex text-yellow-400 mb-2">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <span class="material-symbols-outlined !text-base md:!text-lg <%= i <= r.rating ? 'fill-current' : 'text-gray-300' %>">star</span>
                  <% } %>
                </div>
                <p class="text-sm text-[#4e7397] italic line-clamp-3 leading-relaxed">"<%= r.comment || 'No comment provided' %>"</p>
              </div>
              <% if (r.listing) { %>
                <a href="/listings/<%= r.listing._id %>" class="mt-4 text-primary text-[10px] font-bold uppercase tracking-widest hover:underline">View Listing</a>
              <% } %>
            </div>
          <% }) %>
        <% } %>
      </div>
    </section>

  </div>
</main>

<script>
  const tabs = document.querySelectorAll(".tab-btn-v2");
  const sections = document.querySelectorAll(".tab-section");

  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      // Toggle button active styles
      tabs.forEach(t => {
        t.classList.remove("border-primary", "text-primary");
        t.classList.add("border-transparent", "text-[#4e7397]");
      });
      btn.classList.add("border-primary", "text-primary");
      btn.classList.remove("border-transparent", "text-[#4e7397]");

      // Switch sections
      sections.forEach(sec => sec.classList.remove("active"));
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });
</script>